
{{if (.Vars.flags.testmerge) }}
command:
  xmlstarlet sel -N activemq="urn:activemq" -N core="urn:activemq:core" -t -v "activemq:configuration/core:core/core:security-enabled" /var/lib/artemis/etc/broker.xml:
    exit-status: 0
    stdout:
    - false
    stderr: []
    timeout: 1000
{{end}}

command:
  ps -ef|grep -v grep|grep java:
    exit-status: 0
    stdout:
{{if getEnv "BROKER_CONFIG_GLOBAL_MAX_SIZE" }}
    - "-Dbrokerconfig.globalMaxSize={{ .Env.BROKER_CONFIG_GLOBAL_MAX_SIZE }}"
{{end}}
{{if getEnv "JAVA_ARGS_EXTRAS" }}
    - "-Dmyextraarg=myvalue"
{{end}}
{{if not (.Env.ACTIVEMQ_ARTEMIS_VERSION | regexMatch "^(1\\.[0-9]\\.\\d+|2\\.[0-2]\\.\\d+)") }}
  {{if getEnv "HAWTIO_ROLE" }}
    - "-Dhawtio.role={{ .Env.HAWTIO_ROLE }}"
  {{else}}
    - "-Dhawtio.role=amq"
  {{end}}
  {{if getEnv "HAWTIO_REALM" }}
    - "-Dhawtio.realm={{ .Env.HAWTIO_REALM }}"
  {{else}}
    - "-Dhawtio.realm=activemq"
  {{end}}
{{end}}
    stderr: []
    timeout: 1000

port:
  tcp:8161:
    listening: true
{{if getEnv "ENABLE_JMX_EXPORTER" }}
  tcp:9404:
    listening: true
{{end}}

user:
  artemis:
    exists: true
    uid: 1000
    groups:
      - artemis

group:
  artemis:
    exists: true
    gid: 1000

process:
  java:
    running: true

file:
  /opt/apache-artemis:
    exists: true
    owner: root
    group: root
    filetype: symlink
    linked-to: /opt/apache-artemis-{{ .Env.ACTIVEMQ_ARTEMIS_VERSION }}
  
  /opt/apache-artemis-{{ .Env.ACTIVEMQ_ARTEMIS_VERSION }}:
    exists: true
    owner: root
    group: root
    filetype: directory

  /var/lib/artemis:
    exists: true
    owner: artemis
    group: artemis
    filetype: directory
  
  /var/lib/artemis/data:
    exists: true
    owner: artemis
    group: artemis
    filetype: directory

  /var/lib/artemis/etc/broker.xml:
    exists: true
    owner: artemis
    group: artemis
    filetype: file
    contains:
      - brokerconfig.acceptorArtemisArgs
{{ if (getEnv "ENABLE_CLUSTER") }}
      - "cluster-connections"
{{ end }}
{{ if (getEnv "CLUSTER_NAME") }}
      - "cluster-connection name=\"{{ .Env.CLUSTER_NAME }}\""
{{ end }}
{{ if (getEnv "CLUSTER_USER") }}
      - "<cluster-user>{{ .Env.CLUSTER_USER }}</cluster-user>"
      - "<cluster-password>{{ .Env.CLUSTER_PASSWORD }}</cluster-password>"
{{ end }}
{{ if (getEnv "HA_ROLE") }}
      - "<ha-policy>"
{{ end }}
{{ if (getEnv "HA_GROUP_NAME") }}
      - "<group-name>{{ .Env.HA_GROUP_NAME }}</group-name>"
{{ end }}
{{ if (getEnv "CLUSTER_URI") }}
      - "<connector name=\"artemis\">{{ .Env.CLUSTER_URI }}</connector>"
{{ end }}
{{ if (getEnv "CLUSTER_CONNECTIONS") }}
      - "<connector-ref>artemis-1-localhost</connector-ref></static-connectors>"
      - "<connector name=\"artemis-1-localhost\">tcp://localhost:61616${brokerconfig.connectorArgs}</connector>"
{{ end }}
{{ if (.Env.ACTIVEMQ_ARTEMIS_VERSION | regexMatch "(1\\.[^0-2]\\.[0-9]+|2\\.[0-9]\\.[0-9]+)") }}
      - <name>{{.Vars.hostname}}</name>
  {{if getEnv "DISABLE_SECURITY" }}
      - <security-enabled>false</security-enabled>
  {{end}}
{{ end }}

  /var/lib/artemis/etc/artemis-users.properties:
    exists: true
    owner: artemis
    group: artemis
    filetype: file
    contains:
{{if (getEnv "ARTEMIS_PASSWORD") }}
  {{ if and (getEnv "ACTIVEMQ_ARTEMIS_VERSION" "") (.Env.ACTIVEMQ_ARTEMIS_VERSION | regexMatch "1.[0-4].0") }}
      - {{.Env.ARTEMIS_USERNAME }}={{ .Env.ARTEMIS_PASSWORD }}
  {{ else }}
      - /{{.Env.ARTEMIS_USERNAME }} *= *ENC/
  {{ end }}
{{end}}

  /var/lib/artemis/etc/artemis-roles.properties:
    exists: true
    owner: artemis
    group: artemis
    filetype: file
{{if (getEnv "ARTEMIS_USERNAME") }}
    contains: 
  {{ if and (getEnv "ACTIVEMQ_ARTEMIS_VERSION" "") (.Env.ACTIVEMQ_ARTEMIS_VERSION | regexMatch "1.[01].0") }}
      - /{{ .Env.ARTEMIS_USERNAME }} *= *amq/
  {{ else }}
      - /amq *= *{{ .Env.ARTEMIS_USERNAME }}/
  {{ end }}
{{ else }}
    contains: 
  {{ if and (getEnv "ACTIVEMQ_ARTEMIS_VERSION" "") (.Env.ACTIVEMQ_ARTEMIS_VERSION | regexMatch "1.[01].0") }}
      - /artemis *= *amq/
  {{ else }}
      - /amq *= *artemis/
  {{ end }}
{{end}}

  /var/lib/artemis/data/.perf-journal-completed:
{{ if .Env.ACTIVEMQ_ARTEMIS_VERSION | regexMatch "(1.5.[3-5]|[^1]\\.\\d+\\.\\d+)" }}
    exists: true
    owner: artemis
    group: artemis
    filetype: file
{{ else }}
    exists: false
{{ end }}

  /var/lib/artemis/etc/artemis.profile:
    exists: true
    owner: artemis
    group: artemis
    filetype: file
    contains:
      - "-Djava.net.preferIPv4Addresses=true"
      - "-XX:+UnlockExperimentalVMOptions"
      - "-XX:+UseCGroupMemoryLimitForHeap"
      - "-XX:MaxRAMFraction=2"
{{if getEnv "ENABLE_JMX_EXPORTER" }}
      - "jmx_prometheus_javaagent.jar=9404"
{{else}}
      - "!jmx_prometheus_javaagent.jar"  
{{end}} 
      - "$BROKER_CONFIGS"
{{ if or (getEnv "ARTEMIS_MIN_MEMORY") (getEnv "ARTEMIS_MAX_MEMORY") (getEnv "ENABLE_JMX") }}
  {{if getEnv "ARTEMIS_MIN_MEMORY" }}
      - "-Xms{{ .Env.ARTEMIS_MIN_MEMORY }}"
  {{else}}
      - "!-Xms"  
  {{end}}
  {{if getEnv "ARTEMIS_MAX_MEMORY" }}
      - "-Xmx{{ .Env.ARTEMIS_MAX_MEMORY }}"
  {{ else }}
      - "!-Xmx"
  {{end}}
  {{if getEnv "ENABLE_JMX" }}
      - "-Dcom.sun.management.jmxremote=true"
      {{ if getEnv "JMX_PORT" }}
      - "-Dcom.sun.management.jmxremote.port={{ .Env.JMX_PORT }}"
      {{ end }}
      {{ if getEnv "JMX_PORT" }}
      - "-Dcom.sun.management.jmxremote.rmi.port={{ .Env.JMX_RMI_PORT }}"
      {{ end }}
      - "-Dcom.sun.management.jmxremote.ssl=false"
      - "-Dcom.sun.management.jmxremote.authenticate=false"
  {{end}}
{{end}}

  /var/lib/artemis/etc/bootstrap.xml:
    exists: true
    owner: artemis
    group: artemis
    filetype: file
    contains:
{{if not (.Env.ACTIVEMQ_ARTEMIS_VERSION | regexMatch "^(1\\.[0-9]\\.\\d+|2\\.[0-2]\\.\\d+)") }}
  {{ if (getEnv "ARTEMIS_JAAS_DOMAIN") }}
      - "domain=\"{{ .Env.ARTEMIS_JAAS_DOMAIN }}\""
  {{ else }}
      - "domain=\"activemq\""
  {{ end }}
{{ end }}

{{if not (.Env.ACTIVEMQ_ARTEMIS_VERSION | regexMatch "^(1\\.[0-9]\\.\\d+|2\\.[0-2]\\.\\d+)") }}
  /var/lib/artemis/etc/login.config:
    exists: true
    owner: artemis
    group: artemis
    filetype: file
    contains:
  {{ if (getEnv "LDAP_ENABLED") }}
      - "org.apache.activemq.artemis.spi.core.security.jaas.LDAPLoginModule"
  {{ end }}
  {{ if (getEnv "LDAP_CONNECTION_URL") }}
      - "connectionURL=\"{{ .Env.LDAP_CONNECTION_URL }}\""
  {{ end }}
{{ end }}

